<!DOCTYPE html>
<html>
    <head>
        <title>Form di conferma</title>
        <script
            src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
            crossorigin="anonymous">
        </script>
        <link rel="stylesheet" type="text/css" href="/static/style.css">
    </head>
    <body>
        <h1>Form di conferma</h1>
        <form class="guest_form" action="/guest/{{ .UUID }}" method="post">
            <label for="guests">Numero <b>totale</b> di partecipanti:</label>
            <input type="number" id="guests" name="guests" min="1" max="5" value="1" required>
            <br>
            <div class="divs">
              <div>
                <input type="text" name="first_name_1" placeholder="Nome"/>
                <input type="text" name="last_name_1" placeholder="Cognome"/>
                <input type="text" name="notes_1" placeholder="Intolleranze/allergie"/>
              </div>
            </div>
            <button type="button" onclick="submitForm()">Conferma</button>
        </form>
    </body>
    <script>
        var min = 1;
        var max = 5;
        var oldVal = 1;
        var form = $(".guest_form");

        function submitForm() {
            var formData = {
                guests: parseInt($("#guests").val()),
                notes: $("#notes").val(),
                people: []
            };

            $(".divs div").each(function(index) {
                var firstName = $(this).find("input[name^='first_name']").val();
                var lastName = $(this).find("input[name^='last_name']").val();
                var notesData = $(this).find("input[name^='notes']").val();
                formData.people.push({ first_name: firstName, last_name: lastName, notes: notesData});
            });

            // Convert form data to JSON
            var jsonData = JSON.stringify(formData);

            // Example of sending JSON data using jQuery AJAX
            $.ajax({
                url: form.attr("action"),
                type: "POST",
                contentType: "application/json",
                data: jsonData,
                success: function(response) {
                    // Handle success response
                },
                error: function(xhr, status, error) {
                    // Handle error response
                }
            });
        }

        $("#guests").on("change keyup paste", function() {
            var currentVal = parseInt($("#guests").val()); // Parse the value to an integer
            if(isNaN(currentVal)){ // Check if the value is not a number
                currentVal = min; // Set currentVal to min if it's NaN
            }
            if(currentVal < min || currentVal > max){
                if ($("#guests-error").length === 0) { // Check if error message does not exist
                    $("<span id='guests-error' style='color: red;'>Invalid value. Please enter a number between " + min + " and " + max + ".</span>").insertAfter("#guests");
                }
                currentVal = oldVal; // Revert to the old value if the input is invalid
            } else {
                $("#guests-error").remove(); // Remove error message if input is valid
            }
            if(currentVal == oldVal) {
                return;
            }
            if(currentVal > oldVal){
                for(i=oldVal;i<currentVal;i++){
                fieldHTML = fieldHTML = `<div>
                <input type="text" name="first_name_'+currentVal+'" placeholder="Nome"/>
                <input type="text" name="last_name_'+currentVal+'" placeholder="Cognome"/>
                <input type="text" name="notes_'+currentVal+'" placeholder="Intolleranze/allergie"/>
                </div>`;
                $(".divs").append(fieldHTML); // Append new divs to outer div with class "divs"
                }
            }
            if(currentVal < oldVal){
                $(".guest_form .divs div").slice(currentVal).remove();
            }
            oldVal = currentVal;
        });
    </script>
</html>